<div class="user-edit-container">
  
  <!-- Page Header -->
  <div class="page-header mb-4">
    <div>
      <h2 class="page-title">
        <i class="fas fa-user-edit me-2"></i>
        Edición de usuario
      </h2>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoadingData) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-muted">Cargando datos del usuario...</p>
    </div>
  }

  <!-- Success/Error Messages -->
  @if (successMessage) {
    <app-alert-message 
      type="success" 
      [message]="successMessage"
      [dismissible]="true"
      (onDismiss)="dismissSuccess()">
    </app-alert-message>
  }

  @if (errorMessage) {
    <app-alert-message 
      type="error" 
      [message]="errorMessage"
      [dismissible]="true"
      (onDismiss)="dismissError()">
    </app-alert-message>
  }

  <!-- Two Column Layout -->
  @if (!isLoadingData && user) {
    <div class="row">
      
      <!-- LEFT COLUMN: Edit User Form -->
      <div class="col-lg-6 mb-4">
        <div class="card card-warning">
          <div class="card-header">
            <i class="fas fa-edit me-2"></i>
            Editar Usuario
          </div>
          <div class="card-body">
            
            <!-- User Info Badge -->
            <div class="alert alert-info mb-4" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Editando:</strong> {{ user.firstName }} {{ user.lastName }}
              <span class="badge bg-danger ms-2">Admin</span>
            </div>

            <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
              
              <!-- First Name -->
              <div class="form-group mb-3">
                <label for="firstName" class="form-label">
                  <i class="fas fa-user me-2"></i>
                  Nombre del Usuario
                </label>
                <input
                  type="text"
                  id="firstName"
                  class="form-control"
                  [class.is-invalid]="hasError('firstName', 'required') || hasError('firstName', 'minlength')"
                  formControlName="firstName"
                  placeholder="Ingresa el nombre">
                @if (hasError('firstName', 'required') || hasError('firstName', 'minlength')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('firstName') }}
                  </div>
                }
              </div>

              <!-- Last Name -->
              <div class="form-group mb-3">
                <label for="lastName" class="form-label">
                  <i class="fas fa-user me-2"></i>
                  Apellido
                </label>
                <input
                  type="text"
                  id="lastName"
                  class="form-control"
                  [class.is-invalid]="hasError('lastName', 'required') || hasError('lastName', 'minlength')"
                  formControlName="lastName"
                  placeholder="Ingresa el apellido">
                @if (hasError('lastName', 'required') || hasError('lastName', 'minlength')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('lastName') }}
                  </div>
                }
              </div>

              <!-- Email (Read-only) -->
              <div class="form-group mb-3">
                <label for="email" class="form-label">
                  <i class="fas fa-envelope me-2"></i>
                  Correo Electrónico
                </label>
                <input
                  type="email"
                  id="email"
                  class="form-control"
                  formControlName="email"
                  readonly>
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  El email no puede ser modificado
                </small>
              </div>

              <!-- Phone Number -->
              <div class="form-group mb-3">
                <label for="phoneNumber" class="form-label">
                  <i class="fas fa-phone me-2"></i>
                  Teléfono (opcional)
                </label>
                <input
                  type="tel"
                  id="phoneNumber"
                  class="form-control"
                  [class.is-invalid]="hasError('phoneNumber', 'pattern')"
                  formControlName="phoneNumber"
                  placeholder="+51987654321">
                @if (hasError('phoneNumber', 'pattern')) {
                  <div class="invalid-feedback">
                    {{ getErrorMessage('phoneNumber') }}
                  </div>
                }
              </div>

              <!-- Roles Selection -->
              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="fas fa-user-shield me-2"></i>
                  Roles
                </label>
                <div class="roles-container">
                  @for (role of roles; track role.id) {
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        [id]="'role-' + role.id"
                        [checked]="isRoleSelected(role.id)"
                        (change)="onRoleChange(role.id, $event)">
                      <label class="form-check-label" [for]="'role-' + role.id">
                        {{ role.name }}
                      </label>
                    </div>
                  }
                </div>
                @if (hasError('roleIds', 'required')) {
                  <div class="text-danger mt-2">
                    <small>Debe seleccionar al menos un rol</small>
                  </div>
                }
              </div>

              <!-- Status Toggle -->
              <div class="form-group mb-4">
                <label class="form-label">
                  <i class="fas fa-toggle-on me-2"></i>
                  Estado
                </label>
                <div class="status-toggle">
                  <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="statusToggle"
                      [checked]="userForm.get('status')?.value"
                      (change)="onStatusToggle($event)">
                    <label class="form-check-label" for="statusToggle">
                      @if (userForm.get('status')?.value) {
                        <span class="badge bg-success">Usuario activo</span>
                      } @else {
                        <span class="badge bg-danger">Usuario inactivo</span>
                      }
                    </label>
                  </div>
                  <small class="form-text text-muted d-block mt-2">
                    Usuario activo - Puedes activar/desactivar este usuario
                  </small>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="cancel()"
                  [disabled]="isLoading">
                  <i class="fas fa-arrow-left me-2"></i>
                  Volver a Usuarios
                </button>
                
                <button
                  type="submit"
                  class="btn btn-warning text-dark"
                  [disabled]="isLoading || userForm.invalid">
                  @if (!isLoading) {
                    <i class="fas fa-save me-2"></i>
                    <span>Actualizar Usuario</span>
                  } @else {
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span>Actualizando...</span>
                  }
                </button>
              </div>

            </form>

          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Generate New Password -->
      <div class="col-lg-6 mb-4">
        <div class="card card-cyan">
          <div class="card-header">
            <i class="fas fa-key me-2"></i>
            Generar Nueva Contraseña
          </div>
          <div class="card-body">
            
            <div class="alert alert-info" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              Si el usuario reporta que no recibió sus credenciales o necesita una nueva contraseña, 
              puede generar una nueva y enviarla por correo.
            </div>

            @if (!showPasswordSection) {
              <div class="d-grid">
                <button
                  type="button"
                  class="btn btn-info btn-lg"
                  (click)="onGenerateNewPassword()">
                  <i class="fas fa-sync-alt me-2"></i>
                  Generar Nueva Contraseña
                </button>
              </div>
            }

            @if (showPasswordSection && newGeneratedPassword) {
              <!-- Generated Password Display -->
              <div class="new-password-box mb-3">
                <label class="form-label">
                  <i class="fas fa-lock me-2"></i>
                  Nueva Contraseña
                </label>
                <div class="password-display">
                  {{ newGeneratedPassword }}
                </div>
              </div>

              <!-- Credentials to Send -->
              <div class="alert alert-info" role="alert">
                <i class="fas fa-paper-plane me-2"></i>
                <strong>Credenciales a enviar:</strong>
              </div>

              <div class="credentials-info mb-3">
                <div class="credential-row">
                  <strong>Nombre:</strong>
                  <span>{{ user.firstName }} {{ user.lastName }}</span>
                </div>
                <div class="credential-row">
                  <strong>Correo:</strong>
                  <span>{{ user.email }}</span>
                </div>
                <div class="credential-row">
                  <strong>Nueva Contraseña:</strong>
                  <span class="password-text">{{ newGeneratedPassword }}</span>
                </div>
                <div class="credential-row">
                  <strong>Link del Sistema:</strong>
                  <a href="http://localhost:8000/login" target="_blank" class="link-primary">
                    http://localhost:8000/login
                  </a>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-grid gap-2">
                <button
                  type="button"
                  class="btn btn-info"
                  (click)="sendCredentialsByEmail()"
                  [disabled]="isLoading">
                  <i class="fas fa-paper-plane me-2"></i>
                  Enviar Credenciales
                </button>

                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="showPasswordSection = false; newGeneratedPassword = null">
                  <i class="fas fa-times me-2"></i>
                  Cancelar
                </button>
              </div>
            }

          </div>
        </div>
      </div>

    </div>
  }

</div>