<div class="role-create-container">
  
  <!-- Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h2 class="page-title mb-1">
          <i class="fas fa-user-shield me-2"></i>
          Crear Nuevo Rol
        </h2>
        <p class="text-muted mb-0">Define el nombre, descripción y permisos del rol</p>
      </div>
      
      <button 
        class="btn btn-outline-secondary"
        (click)="cancel()"
        [disabled]="isLoading">
        <i class="fas fa-times me-2"></i>
        Cancelar
      </button>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <app-alert-message 
      type="error" 
      [message]="errorMessage"
      [dismissible]="true"
      (onDismiss)="dismissError()">
    </app-alert-message>
  }

  <form [formGroup]="roleForm" (ngSubmit)="onSubmit()">
    
    <!-- Información Básica -->
    <div class="card mb-4">
      <div class="card-header">
        <strong>
          <i class="fas fa-info-circle me-2"></i>
          Información Básica
        </strong>
      </div>
      <div class="card-body">
        <div class="row g-3">
          
          <!-- Nombre del Rol -->
          <div class="col-md-6">
            <label for="name" class="form-label fw-semibold">
              Nombre del Rol <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              id="name"
              class="form-control"
              formControlName="name"
              placeholder="Ej: SUPERVISOR"
              [class.is-invalid]="hasError('name', 'required') || hasError('name', 'minlength') || hasError('name', 'maxlength')">
            
            @if (hasError('name', 'required') || hasError('name', 'minlength') || hasError('name', 'maxlength')) {
              <div class="invalid-feedback">
                {{ getErrorMessage('name') }}
              </div>
            }
            
            <small class="form-text text-muted">
              Nombre único del rol en mayúsculas (ej: ADMIN, SUPERVISOR)
            </small>
          </div>

          <!-- Estado -->
          <div class="col-md-6">
            <label for="status" class="form-label fw-semibold">
              Estado
            </label>
            <select id="status" class="form-select" formControlName="status">
              <option [value]="true">Activo</option>
              <option [value]="false">Inactivo</option>
            </select>
            <small class="form-text text-muted">
              Solo los roles activos pueden ser asignados a usuarios
            </small>
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label for="description" class="form-label fw-semibold">
              Descripción
            </label>
            <textarea
              id="description"
              class="form-control"
              formControlName="description"
              rows="3"
              placeholder="Descripción del rol y sus responsabilidades..."
              [class.is-invalid]="hasError('description', 'maxlength')">
            </textarea>
            
            @if (hasError('description', 'maxlength')) {
              <div class="invalid-feedback">
                {{ getErrorMessage('description') }}
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Permisos -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>
          <i class="fas fa-key me-2"></i>
          Permisos del Rol 
          <span class="badge bg-primary ms-2">{{ getSelectedPermissionsCount() }} seleccionados</span>
        </strong>
        
        <div class="btn-group btn-group-sm">
          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="selectAllPermissions()"
            [disabled]="isLoadingPermissions">
            <i class="fas fa-check-double me-1"></i>
            Seleccionar Todos
          </button>
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="clearAllPermissions()"
            [disabled]="isLoadingPermissions">
            <i class="fas fa-times me-1"></i>
            Limpiar
          </button>
        </div>
      </div>
      
      <div class="card-body">
        
        <!-- Loading Permissions -->
        @if (isLoadingPermissions) {
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando permisos...</span>
            </div>
            <p class="mt-2 text-muted">Cargando permisos del sistema...</p>
          </div>
        }

        <!-- Permissions by Module -->
        @if (!isLoadingPermissions && permissionGroups.length > 0) {
          <div class="row g-3">
            @for (group of permissionGroups; track group.module) {
              <div class="col-12">
                <div class="permission-module">
                  
                  <!-- Module Header -->
                  <div class="module-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="fas fa-folder-open me-2"></i>
                      {{ group.module | titlecase }}
                      <span class="badge bg-secondary ms-2">{{ group.permissions.length }}</span>
                    </h6>
                    
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      (click)="toggleModulePermissions(group)">
                      @if (areAllModulePermissionsSelected(group)) {
                        <i class="fas fa-check-square me-1"></i>
                        Deseleccionar todos
                      } @else {
                        <i class="far fa-square me-1"></i>
                        Seleccionar todos
                      }
                    </button>
                  </div>

                  <!-- Module Permissions -->
                  <div class="module-permissions">
                    <div class="row g-2">
                      @for (permission of group.permissions; track permission.id) {
                        <div class="col-md-6 col-lg-4">
                          <div class="form-check permission-item">
                            <input
                              type="checkbox"
                              class="form-check-input"
                              [id]="'permission-' + permission.id"
                              [checked]="isPermissionSelected(permission.id)"
                              (change)="togglePermission(permission.id)">
                            
                            <label 
                              class="form-check-label"
                              [for]="'permission-' + permission.id">
                              <strong>{{ permission.name }}</strong>
                              @if (permission.description) {
                                <br>
                                <small class="text-muted">{{ permission.description }}</small>
                              }
                            </label>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }

        <!-- No Permissions -->
        @if (!isLoadingPermissions && permissionGroups.length === 0) {
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
            <p class="text-muted">No hay permisos disponibles en el sistema</p>
          </div>
        }
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-end gap-2">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancel()"
            [disabled]="isLoading">
            <i class="fas fa-times me-2"></i>
            Cancelar
          </button>

          <button
            type="submit"
            class="btn btn-success"
            [disabled]="isLoading || roleForm.invalid || getSelectedPermissionsCount() === 0">
            @if (isLoading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Creando...
            } @else {
              <i class="fas fa-save me-2"></i>
              Crear Rol
            }
          </button>
        </div>
      </div>
    </div>

  </form>

</div>