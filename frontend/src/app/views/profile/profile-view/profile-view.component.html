<!-- LOADING -->
@if (loading) {
  <div class="text-center py-5">
    <c-spinner color="primary"></c-spinner>
    <p class="mt-3 text-muted">Cargando perfil...</p>
  </div>
}

<!-- PROFILE CONTENT -->
@if (!loading && currentUser) {
  <c-row>
    <!-- COLUMNA IZQUIERDA: INFO BÁSICA -->
    <c-col xs="12" lg="4">
      <c-card class="mb-4">
        <c-card-header class="text-center bg-primary text-white">
          <h5 class="mb-0">Mi Perfil</h5>
        </c-card-header>
        <c-card-body class="text-center">
          <!-- AVATAR -->
          <div class="mb-4">
            @if (currentUser.profilePicture) {
              <c-avatar
                [src]="currentUser.profilePicture"
                size="xl"
                class="mb-3"
              ></c-avatar>
            } @else {
              <c-avatar
                color="primary"
                size="xl"
                textColor="white"
                class="mb-3"
              >
                {{ getUserInitials() }}
              </c-avatar>
            }
          </div>

          <!-- NOMBRE -->
          <h4 class="mb-1">{{ getFullName() }}</h4>
          <p class="text-muted mb-3">{{ currentUser.email }}</p>

          <!-- BADGES -->
          <div class="d-flex justify-content-center gap-2 mb-3">
            <c-badge 
              [color]="currentUser.status ? 'success' : 'danger'"
            >
              {{ currentUser.status ? 'Activo' : 'Inactivo' }}
            </c-badge>
            <c-badge 
              [color]="currentUser.emailVerified ? 'info' : 'warning'"
            >
              {{ currentUser.emailVerified ? 'Email Verificado' : 'Email Pendiente' }}
            </c-badge>
          </div>

          <!-- BOTÓN EDITAR -->
          <button
            cButton
            color="primary"
            class="w-100"
            [routerLink]="['/profile/edit']"
          >
            <svg cIcon name="cilPencil" class="me-2"></svg>
            Editar Perfil
          </button>
        </c-card-body>
      </c-card>

      <!-- ROLES -->
      @if (currentUser.roles && currentUser.roles.length > 0) {
        <c-card class="mb-4">
          <c-card-header>
            <strong>Roles Asignados</strong>
          </c-card-header>
          <c-card-body>
            <div class="d-flex flex-wrap gap-2">
              @for (role of currentUser.roles; track role) {
                <c-badge 
                  color="secondary"
                  class="px-3 py-2"
                >
                  {{ role }}
                </c-badge>
              }
            </div>
          </c-card-body>
        </c-card>
      }
    </c-col>

    <!-- COLUMNA DERECHA: DETALLES -->
    <c-col xs="12" lg="8">
      <c-card class="mb-4">
        <c-card-header>
          <strong>Información Personal</strong>
        </c-card-header>
        <c-card-body>
          <table class="table table-borderless">
            <tbody>
              <tr>
                <td class="text-muted" style="width: 30%">
                  <svg cIcon name="cilUser" class="me-2"></svg>
                  Nombre:
                </td>
                <td><strong>{{ currentUser.firstName }}</strong></td>
              </tr>
              <tr>
                <td class="text-muted">
                  <svg cIcon name="cilUser" class="me-2"></svg>
                  Apellido:
                </td>
                <td><strong>{{ currentUser.lastName }}</strong></td>
              </tr>
              <tr>
                <td class="text-muted">
                  <svg cIcon name="cilEnvelopeClosed" class="me-2"></svg>
                  Email:
                </td>
                <td><strong>{{ currentUser.email }}</strong></td>
              </tr>
              @if (currentUser.phoneNumber) {
                <tr>
                  <td class="text-muted">
                    <svg cIcon name="cilPhone" class="me-2"></svg>
                    Teléfono:
                  </td>
                  <td><strong>{{ currentUser.phoneNumber }}</strong></td>
                </tr>
              }
            </tbody>
          </table>
        </c-card-body>
      </c-card>

      <!-- INFORMACIÓN DE CUENTA -->
      <c-card class="mb-4">
        <c-card-header>
          <strong>Información de Cuenta</strong>
        </c-card-header>
        <c-card-body>
          <table class="table table-borderless">
            <tbody>
              <tr>
                <td class="text-muted" style="width: 30%">
                  <svg cIcon name="cilShieldAlt" class="me-2"></svg>
                  Estado:
                </td>
                <td>
                  <c-badge [color]="currentUser.status ? 'success' : 'danger'">
                    {{ currentUser.status ? 'Cuenta Activa' : 'Cuenta Inactiva' }}
                  </c-badge>
                </td>
              </tr>
              <tr>
                <td class="text-muted">
                  <svg cIcon name="cilCheckCircle" class="me-2"></svg>
                  Verificación de Email:
                </td>
                <td>
                  <c-badge [color]="currentUser.emailVerified ? 'success' : 'warning'">
                    {{ currentUser.emailVerified ? 'Verificado' : 'Pendiente' }}
                  </c-badge>
                </td>
              </tr>
            </tbody>
          </table>
        </c-card-body>
      </c-card>

      <!-- ACCIONES DE SEGURIDAD -->
      <c-card>
        <c-card-header>
          <strong>Seguridad</strong>
        </c-card-header>
        <c-card-body>
          <button
            cButton
            color="warning"
            variant="outline"
            [routerLink]="['/profile/change-password']"
          >
            <svg cIcon name="cilLockLocked" class="me-2"></svg>
            Cambiar Contraseña
          </button>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}

<!-- NO USER -->
@if (!loading && !currentUser) {
  <div class="text-center py-5">
    <svg cIcon name="cilUser" size="xxl" class="text-muted mb-3"></svg>
    <h5 class="text-muted">No se pudo cargar la información del perfil</h5>
    <button cButton color="primary" class="mt-3" (click)="loadProfile()">
      Reintentar
    </button>
  </div>
}