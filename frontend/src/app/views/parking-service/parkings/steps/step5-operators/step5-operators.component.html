<!-- steps/step5-operators/step5-operators.component.html -->

<!-- CARGANDO CATÁLOGOS -->
@if (loadingCatalogs) {
  <div class="text-center py-5">
    <c-spinner color="primary"></c-spinner>
    <p class="text-muted mt-2">Cargando operadores y turnos...</p>
  </div>
}

<!-- ERROR DE CATÁLOGO -->
@if (catalogError) {
  <c-alert color="danger">
    <c-icon name="cilWarning" class="me-2"></c-icon>{{ catalogError }}
    <button cButton color="danger" variant="outline" size="sm" class="ms-3"
            (click)="loadCatalogs()">
      <c-icon name="cilReload" class="me-1"></c-icon>Reintentar
    </button>
  </c-alert>
}

<!-- CONTENIDO PRINCIPAL -->
@if (!loadingCatalogs && !catalogError) {

  <!-- ERROR -->
  @if (errorMessage) {
    <c-alert color="warning" [dismissible]="true">
      <c-icon name="cilWarning" class="me-2"></c-icon>{{ errorMessage }}
    </c-alert>
  }

  <!-- INFO -->
  <c-alert color="info" class="mb-4">
    <c-icon name="cilInfo" class="me-2"></c-icon>
    Asigna operadores a zonas y turnos. Este paso es <strong>opcional</strong> —
    puedes finalizar sin asignaciones y hacerlo después.
  </c-alert>

  <!-- FORMULARIO DE NUEVA ASIGNACIÓN -->
  <c-card class="mb-4">
    <c-card-header>
      <strong>
        <c-icon name="cilUserPlus" class="me-2"></c-icon>
        Nueva Asignación
      </strong>
    </c-card-header>
    <c-card-body>
      <form [formGroup]="form" novalidate>

        <!-- FILA 1: Operador + Zona + Turno -->
        <div cRow class="mb-3">

          <div cCol sm="4">
            <label cLabel>Operador <span class="text-danger">*</span></label>
            <select cSelect formControlName="operatorId"
                    [class.is-invalid]="form.get('operatorId')?.invalid && form.get('operatorId')?.touched">
              <option [value]="null">— Seleccionar —</option>
              @for (op of operators; track op.id) {
                <option [value]="op.id">{{ op.name }}</option>
              }
            </select>
            @if (form.get('operatorId')?.invalid && form.get('operatorId')?.touched) {
              <c-form-feedback [valid]="false">Selecciona un operador.</c-form-feedback>
            }
          </div>

          <div cCol sm="4">
            <label cLabel>Zona <span class="text-danger">*</span></label>
            <select cSelect formControlName="zoneId"
                    [class.is-invalid]="form.get('zoneId')?.invalid && form.get('zoneId')?.touched">
              <option [value]="null">— Seleccionar —</option>
              @for (zone of zones; track zone.id) {
                <option [value]="zone.id">{{ zone.code }} — {{ zone.name }}</option>
              }
            </select>
            @if (form.get('zoneId')?.invalid && form.get('zoneId')?.touched) {
              <c-form-feedback [valid]="false">Selecciona una zona.</c-form-feedback>
            }
          </div>

          <div cCol sm="4">
            <label cLabel>Turno <span class="text-danger">*</span></label>
            <select cSelect formControlName="shiftId"
                    [class.is-invalid]="form.get('shiftId')?.invalid && form.get('shiftId')?.touched">
              <option [value]="null">— Seleccionar —</option>
              @for (shift of shifts; track shift.id) {
                <option [value]="shift.id">{{ shift.name }}</option>
              }
            </select>
            @if (form.get('shiftId')?.invalid && form.get('shiftId')?.touched) {
              <c-form-feedback [valid]="false">Selecciona un turno.</c-form-feedback>
            }
          </div>

        </div>

        <!-- FILA 2: Días de la semana -->
        <div cRow class="mb-3">
          <div cCol sm="12">
            <label cLabel>Días de la semana <span class="text-danger">*</span></label>
            <div class="d-flex flex-wrap gap-2 mt-1">
              @for (day of allDays; track day) {
                <div class="day-chip"
                     [class.selected]="isDaySelected(day)"
                     (click)="toggleDay(day)">
                  {{ getDayLabel(day) }}
                </div>
              }
            </div>
            @if (selectedDays.size === 0 && form.touched) {
              <div class="text-danger small mt-1">Selecciona al menos un día.</div>
            }
          </div>
        </div>

        <!-- BOTÓN AGREGAR -->
        <div class="d-flex justify-content-end">
          <button type="button" cButton color="secondary"
                  (click)="addAssignment()">
            <c-icon name="cilPlus" class="me-1"></c-icon>
            Agregar asignación
          </button>
        </div>

      </form>
    </c-card-body>
  </c-card>

  <!-- TABLA DE ASIGNACIONES -->
  @if (assignments.length > 0) {
    <c-card class="mb-4">
      <c-card-header>
        <strong>
          <c-icon name="cilPeople" class="me-2"></c-icon>
          Asignaciones confirmadas
        </strong>
        <c-badge color="primary" class="ms-2">{{ assignments.length }}</c-badge>
      </c-card-header>
      <c-card-body class="p-0">
        <table cTable hover>
          <thead>
            <tr>
              <th>Operador</th>
              <th>Zona</th>
              <th>Turno</th>
              <th>Días</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (a of assignments; track $index) {
              <tr>
                <td>
                  <c-icon name="cilUser" class="me-1 text-muted"></c-icon>
                  {{ a.operatorName }}
                </td>
                <td>
                  <c-badge color="secondary">{{ getZoneName(a.zoneId) }}</c-badge>
                </td>
                <td>
                  <c-badge color="primary">{{ getShiftName(a.shiftId) }}</c-badge>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    @for (day of a.daysOfWeek; track day) {
                      <c-badge color="light" class="text-dark border">
                        {{ getDayLabel(day) }}
                      </c-badge>
                    }
                  </div>
                </td>
                <td class="text-end">
                  <button cButton color="danger" variant="ghost" size="sm"
                          (click)="removeAssignment($index)">
                    <c-icon name="cilTrash"></c-icon>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  }

  <!-- FOOTER: BOTÓN FINALIZAR -->
  <div class="d-flex justify-content-end">
    <button cButton color="success" (click)="onFinish()">
      <c-icon name="cilCheckAlt" class="me-2"></c-icon>
      Finalizar y ver parqueos
    </button>
  </div>

}